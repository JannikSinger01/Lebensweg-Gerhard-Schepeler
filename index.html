<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spuren des Kolonialismus - Christian Gerhard Schepeler</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, .serif {
            font-family: 'Merriweather', serif;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d6d3d1; 
            border-radius: 20px;
        }
        /* Leaflet Popups */
        .leaflet-popup-content-wrapper {
            border-radius: 2px;
            font-family: 'Merriweather', serif;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .leaflet-popup-tip {
            background: white;
        }
        /* Timeline Node Active Pulse */
        .timeline-node-active {
            box-shadow: 0 0 0 3px rgba(180, 83, 9, 0.3);
        }
        
        /* TUTORIAL STYLES */
        .tutorial-active-element {
            position: relative;
            z-index: 60 !important;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            pointer-events: none;
        }
        /* Overlay für den Rest */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        #tutorial-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Edit Mode Styles */
        .waypoint-marker {
            background-color: #fff;
            border: 2px solid #b45309;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: move;
        }
        .cursor-crosshair {
            cursor: crosshair !important;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        amber: {
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-stone-100 text-stone-800 h-screen flex flex-col overflow-hidden">

    <!-- Header Leiste -->
    <header class="bg-stone-900 text-stone-200 p-3 shadow-md z-20 flex justify-between items-center border-b border-stone-700 shrink-0">
        <div>
            <h1 class="text-lg tracking-wider font-bold">SPUREN DES KOLONIALISMUS</h1>
            <p class="text-[10px] text-stone-400 uppercase tracking-widest mt-0.5">Biografie & Handelsrouten</p>
        </div>
        <div class="flex items-center gap-3">
            <!-- Tutorial Button -->
            <button onclick="startTutorial()" class="p-1.5 text-stone-400 hover:bg-stone-800 hover:text-amber-500 rounded-full transition-colors flex items-center gap-2" title="Hilfe / Tutorial">
                <span class="text-xs uppercase font-bold hidden sm:inline">Hilfe</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
            
            <!-- Info Button -->
            <button onclick="toggleIntro()" class="p-1.5 text-stone-400 hover:bg-stone-800 hover:text-stone-200 rounded-full transition-colors" title="Projekt-Info">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </button>
        </div>
    </header>

    <!-- Hauptbereich (Flex Container) -->
    <div class="flex flex-1 relative flex-col md:flex-row overflow-hidden">
        
        <!-- Linke Spalte: Biografie & Steuerung -->
        <div id="sidebar-panel" class="w-full md:w-1/3 lg:w-1/4 bg-white shadow-xl z-10 flex flex-col border-r border-stone-300 h-1/2 md:h-full relative transition-all duration-300">
            
            <!-- Scrollbarer Textbereich -->
            <div class="p-5 flex-1 overflow-y-auto custom-scrollbar relative">
                <div class="mb-3 inline-block px-2 py-0.5 bg-stone-100 border border-stone-300 rounded text-[10px] font-bold text-stone-500 uppercase tracking-widest">
                    Station <span id="station-count">1</span> / 4
                </div>
                
                <h2 id="station-year" class="text-3xl font-bold text-stone-900 mb-1 transition-opacity duration-300">1780</h2>
                <h3 class="text-lg font-medium text-amber-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <span id="station-location">Osnabrück</span>
                </h3>

                <div class="prose prose-stone">
                    <p id="station-description" class="text-sm leading-relaxed mb-4 transition-opacity duration-300 text-stone-800">
                        Beschreibungstext...
                    </p>
                    
                    <div class="bg-stone-50 border-l-4 border-stone-400 p-3 mt-4">
                        <h4 class="text-xs font-bold text-stone-900 uppercase mb-1 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                            Historischer Kontext
                        </h4>
                        <p id="station-context" class="text-xs text-stone-600 italic transition-opacity duration-300 leading-relaxed">
                            Kontext...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons (Reduziert für Timeline Fokus) -->
            <div class="p-3 bg-stone-50 border-t border-stone-200 flex justify-between items-center shrink-0">
                <button id="btn-prev" onclick="prevStation()" disabled class="flex items-center gap-1.5 px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition-all opacity-30 cursor-not-allowed hover:bg-stone-200 text-stone-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    Zurück
                </button>
                
                <button id="btn-next" onclick="nextStation()" class="flex items-center gap-1.5 px-5 py-1.5 rounded bg-stone-800 text-white text-xs font-bold uppercase tracking-wide transition-all shadow-md hover:bg-stone-700 hover:shadow-lg">
                    <span id="btn-next-text">Weiter</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
            </div>
        </div>

        <!-- Rechte Spalte: Die Karte & Overlays -->
        <div id="map-wrapper" class="relative flex-1 h-1/2 md:h-full w-full z-0 bg-stone-200 transition-all duration-300">
            <!-- Die Karte -->
            <div id="map" class="absolute inset-0 z-0"></div>

            <!-- Edit Button (NEU & ERWEITERT) -->
            <div class="absolute top-4 right-[300px] z-[500] flex flex-col gap-2">
                <button id="edit-btn" onclick="toggleEditMode()" class="bg-white p-2 rounded shadow-md border border-stone-300 hover:bg-stone-50 text-stone-500 hover:text-amber-700 transition-colors" title="Route anpassen (Klicken & Ziehen)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <div id="edit-hint" class="hidden bg-amber-100 text-amber-800 text-[9px] font-bold p-1 rounded shadow-sm text-center border border-amber-300 uppercase tracking-tighter">
                    Klick auf Linie<br>+ Punkt
                </div>
            </div>

            <!-- Kontext-Panel (Overlay über der Karte) -->
            <div id="context-widget" class="absolute top-4 right-4 z-[500] bg-white/95 backdrop-blur-sm p-4 rounded shadow-xl border border-stone-300 max-w-[280px] transition-transform hover:scale-[1.02]">
                <h4 class="text-[10px] font-bold text-stone-500 uppercase tracking-widest mb-1 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Hintergrund
                </h4>
                <p class="text-xs text-stone-700 mb-3 italic font-serif leading-tight">
                    Die Kehrseite des Reichtums: Leinenhandel und Sklaverei.
                </p>
                <button onclick="toggleContext()" class="w-full flex items-center justify-center gap-2 bg-amber-800 hover:bg-amber-700 text-stone-100 px-3 py-2 rounded text-xs font-bold uppercase tracking-wider transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    <span>Kontext öffnen</span>
                </button>
            </div>

            <!-- Quellenhinweis Karte -->
            <div class="absolute bottom-2 right-2 bg-white/80 px-2 py-1 text-[10px] text-stone-500 z-[400] pointer-events-none rounded shadow-sm">
                Kartendaten: &copy; OpenStreetMap contributors, CartoDB
            </div>
        </div>
    </div>

    <!-- Zeitachse am unteren Bildrand -->
    <footer id="timeline-footer" class="h-16 bg-stone-900 border-t-4 border-amber-800 shrink-0 z-30 relative flex flex-col justify-center shadow-[0_-5px_15px_rgba(0,0,0,0.3)] transition-all duration-300">
        <!-- Connecting Line -->
        <div class="absolute top-1/2 left-10 right-10 h-px bg-stone-700 -translate-y-1/2 z-0"></div>
        
        <!-- Nodes Container -->
        <div id="timeline-container" class="relative z-10 flex justify-between items-center px-10 max-w-5xl mx-auto w-full">
            <!-- Wird per JS befüllt -->
        </div>
    </footer>

    <!-- TUTORIAL OVERLAY ELEMENTS -->
    <div id="tutorial-overlay"></div>

    <!-- 2. Die Tutorial Info Box (Dynamisch positioniert) -->
    <div id="tutorial-box" class="fixed bg-white p-4 rounded shadow-2xl border-l-4 border-amber-600 max-w-sm w-full z-[70] hidden opacity-0 transition-all duration-500 ease-in-out">
        <h3 id="tutorial-title" class="text-lg serif font-bold text-stone-900 mb-1">Tutorial Start</h3>
        <p id="tutorial-text" class="text-xs text-stone-600 mb-4 leading-relaxed">Willkommen.</p>
        
        <div class="flex justify-between items-center border-t border-stone-200 pt-3">
            <span id="tutorial-step-indicator" class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Schritt 1/4</span>
            <div class="flex gap-2">
                <button onclick="endTutorial()" class="px-2 py-1 text-[10px] font-bold text-stone-500 hover:text-stone-800 uppercase tracking-wider transition-colors">
                    Ende
                </button>
                <button onclick="nextTutorialStep()" class="px-3 py-1 bg-stone-900 text-white text-[10px] font-bold uppercase tracking-wider hover:bg-stone-700 rounded transition-colors shadow-md">
                    Weiter
                </button>
            </div>
        </div>
    </div>


    <!-- Kontext / Vertiefungs-Modal (Sklaverei) -->
    <div id="context-modal" class="hidden fixed inset-0 bg-stone-900/95 backdrop-blur-md z-[1000] flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-stone-100 max-w-4xl w-full max-h-[90vh] rounded shadow-2xl relative flex flex-col md:flex-row overflow-hidden border border-stone-600">
            <!-- Close Button -->
            <button onclick="toggleContext()" class="absolute top-4 right-4 z-10 text-stone-500 hover:text-stone-900 bg-white/50 rounded-full p-1 hover:bg-white transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <!-- Linke Seite: Text -->
            <div class="w-full md:w-1/2 p-8 overflow-y-auto custom-scrollbar bg-white">
                <div class="mb-4 text-amber-800 font-bold text-xs uppercase tracking-widest border-b border-amber-200 pb-2">Hintergrundinformationen</div>
                <h2 class="text-3xl serif font-bold text-stone-900 mb-6">Osnabrücker Leinen & die koloniale Sklaverei</h2>
                <div class="prose prose-stone prose-sm">
                    <p>Die Geschichte des wohlhabenden Osnabrücker Bürgertums ist untrennbar mit der Ausbeutung versklavter Menschen in Amerika verknüpft. Das berühmte "True Born Osnaburgh" Leinen war kein Luxusgut für europäische Adelige, sondern oft billiges, robustes Gewebe für den Export.</p>
                    <p><strong>Die Kleidung der Unfreiheit:</strong><br>Historische Quellen belegen, dass das grobe Leinen aus Westfalen massenhaft in die Karibik und die Südstaaten der USA verschifft wurde. Dort diente es als Standard-Bekleidung ("Slave Cloth") für Menschen, die auf Baumwoll- und Zuckerrohrplantagen zur Arbeit gezwungen wurden.</p>
                    <blockquote class="border-l-4 border-amber-700 pl-4 italic my-4 text-stone-600">"Der Reichtum hiesiger Kaufleute basierte zu einem nicht unerheblichen Teil auf einem Wirtschaftskreislauf, der menschliches Leid als Treibstoff nutzte."</blockquote>
                    <p>Schepeler, als Kaufmann in London und Spanien tätig, operierte genau an den Schnittstellen dieses Systems. Auch wenn er selbst keine Plantage besaß, so war sein Kapital doch Teil dieser atlantischen Ökonomie.</p>
                </div>
            </div>
            <!-- Rechte Seite: Bilder-Galerie -->
            <div class="w-full md:w-1/2 bg-stone-200 p-8 overflow-y-auto custom-scrollbar flex flex-col gap-6">
                <div class="text-stone-500 text-xs uppercase tracking-widest font-bold mb-2">Historische Quellen & Bilder</div>
                <div class="bg-white p-3 shadow-sm rotate-1 transform hover:rotate-0 transition-transform duration-500">
                    <div class="aspect-video bg-stone-300 flex items-center justify-center text-stone-500 mb-2 overflow-hidden relative">
                         <span class="absolute text-4xl opacity-20 font-serif">IMG</span>
                         <img src="/api/placeholder/400/320" alt="Platzhalter: Leinenweberei" class="object-cover w-full h-full opacity-50 hover:opacity-100 transition-opacity" onerror="this.style.display='none'">
                    </div>
                    <p class="text-[10px] font-serif text-stone-600 italic">Abb. 1: Historische Darstellung der Leinenweberei in Westfalen. (Platzhalter)</p>
                </div>
                <div class="bg-white p-3 shadow-sm -rotate-1 transform hover:rotate-0 transition-transform duration-500">
                    <div class="aspect-video bg-stone-300 flex items-center justify-center text-stone-500 mb-2 overflow-hidden relative">
                         <span class="absolute text-4xl opacity-20 font-serif">IMG</span>
                         <img src="/api/placeholder/400/320" alt="Platzhalter: Plantage" class="object-cover w-full h-full opacity-50 hover:opacity-100 transition-opacity" onerror="this.style.display='none'">
                    </div>
                    <p class="text-[10px] font-serif text-stone-600 italic">Abb. 2: Darstellung einer Plantage in der Karibik, Absatzmarkt für "Osnaburgs". (Platzhalter)</p>
                </div>
                <div class="bg-white p-3 shadow-sm rotate-1 transform hover:rotate-0 transition-transform duration-500">
                    <div class="aspect-square bg-stone-300 flex items-center justify-center text-stone-500 mb-2 overflow-hidden relative">
                         <span class="absolute text-4xl opacity-20 font-serif">DOC</span>
                         <img src="/api/placeholder/400/320" alt="Platzhalter: Dokument" class="object-cover w-full h-full opacity-50 hover:opacity-100 transition-opacity" onerror="this.style.display='none'">
                    </div>
                    <p class="text-[10px] font-serif text-stone-600 italic">Abb. 3: Auszug aus einem Handelsregister oder Brief Schepelers. (Platzhalter)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Start-Modal (Intro) -->
    <div id="intro-modal" class="fixed inset-0 bg-stone-900/80 backdrop-blur-sm z-[1000] flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white max-w-lg w-full p-8 rounded shadow-2xl relative border-t-4 border-amber-700">
            <button onclick="toggleIntro()" class="absolute top-4 right-4 text-stone-400 hover:text-stone-900">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="flex items-center gap-3 mb-4 text-amber-800">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                <h2 class="text-2xl serif font-bold">Biografische Spurensuche</h2>
            </div>
            <p class="text-stone-700 mb-4 leading-relaxed">
                Diese interaktive Karte rekonstruiert den Lebensweg des Osnabrücker Kaufmanns <strong>Christian Gerhard Schepeler</strong> (1780–1841) und zeichnet die Routen des kolonialen Handels nach.
            </p>
            <p class="text-stone-700 mb-6 leading-relaxed">
                Nutzen Sie die <strong>Zeitachse am unteren Rand</strong> oder die Schaltflächen, um durch die Stationen zu navigieren.
            </p>
            <div class="text-xs text-stone-500 border-t border-stone-200 pt-4">
                <p>Projekt: Osnabrück postkolonial. <br>Design-Konzept: Wissenschaftlich-historische Aufbereitung.</p>
            </div>
            <div class="flex flex-col gap-3 mt-6">
                <button onclick="toggleIntro()" class="w-full bg-stone-900 text-white py-3 font-bold uppercase tracking-widest hover:bg-stone-800 transition-colors shadow-md">
                    Erkundung starten
                </button>
                <button onclick="toggleIntro(); startTutorial();" class="w-full bg-white border border-stone-300 text-stone-700 py-2 font-bold uppercase tracking-widest hover:bg-stone-100 transition-colors text-xs">
                    Tutorial ansehen
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- NEUE DATEN STRUKTUR (MIT WAYPOINTS) ---
        // waypoints: Array von Koordinaten [lat, lng] zwischen dieser Station und der nächsten
        const stations = [
            { 
                id: 1, year: "Station 1", location: "Goldküste (Westafrika)", coords: [5.55, -0.20], 
                title: "Handelsplatz & Menschenhandel", 
                description: "Die Goldküste war ein zentraler Ort des transatlantischen Sklavenhandels. Von hier aus wurden versklavte Menschen, oft im Austausch gegen europäische Waren wie Leinen und Waffen, nach Amerika verschifft.", 
                context: "Hier begann für viele Menschen der grausame Weg über den Atlantik.",
                waypoints: [[1.5, -15.0]] // Default curve point towards Atlantic
            },
            { 
                id: 2, year: "Station 2", location: "Atlantik", coords: [15.0, -35.0], 
                title: "Die Middle Passage", 
                description: "Die Route über den Atlantik war Teil des Dreieckshandels. Schiffe transportierten versklavte Menschen unter unmenschlichen Bedingungen in die Kolonien. Auf dem Rückweg brachten sie Kolonialwaren wie Zucker und Baumwolle nach Europa.", 
                context: "Der Atlantik wurde zum Grab für Tausende, die die Überfahrt nicht überlebten.",
                waypoints: [[35.0, -20.0], [48.0, -5.0]] // Curve towards Europe avoiding direct line through Spain/France land
            },
            { 
                id: 3, year: "Station 3", location: "Hamburg", coords: [53.55, 9.99], 
                title: "Tor zur Welt", 
                description: "Hamburg war einer der wichtigsten Importhäfen für Kolonialwaren in Deutschland. Hier kamen Zucker, Kaffee und Baumwolle an, und von hier wurde das 'Osnaburger' Leinen in die Welt exportiert.", 
                context: "Kaufleute in Hamburg und Osnabrück profitierten massiv von dieser Logistik.",
                waypoints: [[53.0, 8.5]] // Small curve to Osnabrück
            },
            { 
                id: 4, year: "Station 4", location: "Osnabrück Marienkirche", coords: [52.277, 8.043], 
                title: "Lokaler Reichtum & Gedenken", 
                description: "In Osnabrück manifestierte sich der Reichtum durch den Leinenhandel in bürgerlichen Bauten und Stiftungen. Die Marienkirche steht symbolisch im Zentrum der Stadt, wo lokale Geschichte und globale Verflechtungen aufeinandertreffen.", 
                context: "Heute ein Ort der Auseinandersetzung mit der eigenen historischen Verantwortung.",
                waypoints: [] 
            }
        ];

        // --- STATUS ---
        let currentIndex = 0;
        let map;
        let markers = [];
        let waypointMarkers = []; // Array to store editing handles
        let polyline;
        let isEditMode = false;

        // --- TUTORIAL LOGIK ---
        let tutorialStep = 0;
        const tutorialSteps = [
            { elementId: 'sidebar-panel', title: 'Stationen & Kontext', text: 'Hier finden Sie Details zu den Stationen des Handelsnetzes.', positionClasses: 'top-1/2 right-4 md:right-10 -translate-y-1/2' },
            { elementId: 'map-wrapper', title: 'Interaktive Karte', text: 'Zoomen und bewegen Sie die Karte, um die Routen zu erkunden.', positionClasses: 'top-1/2 left-4 md:left-10 -translate-y-1/2' },
            { elementId: 'edit-btn', title: 'Route anpassen', text: 'Aktivieren Sie den Stift, um Stationen zu verschieben. Klicken Sie auf die gestrichelte Linie, um neue Punkte hinzuzufügen und die Route zu biegen.', positionClasses: 'top-16 right-[320px]' },
            { elementId: 'context-widget', title: 'Vertiefung', text: 'Öffnen Sie hier vertiefende Informationen zur Geschichte.', positionClasses: 'bottom-24 left-4 md:left-10' },
            { elementId: 'timeline-footer', title: 'Navigation', text: 'Wechseln Sie hier zwischen den geographischen Stationen.', positionClasses: 'top-20 left-1/2 -translate-x-1/2' }
        ];

        function startTutorial() {
            tutorialStep = 0;
            document.getElementById('tutorial-overlay').classList.add('active');
            const box = document.getElementById('tutorial-box');
            box.classList.remove('hidden');
            setTimeout(() => box.classList.remove('opacity-0'), 50);
            updateTutorialStep();
        }

        function updateTutorialStep() {
            document.querySelectorAll('.tutorial-active-element').forEach(el => el.classList.remove('tutorial-active-element'));
            const box = document.getElementById('tutorial-box');
            const step = tutorialSteps[tutorialStep];
            
            document.getElementById('tutorial-title').innerText = step.title;
            document.getElementById('tutorial-text').innerText = step.text;
            document.getElementById('tutorial-step-indicator').innerText = `Schritt ${tutorialStep + 1}/${tutorialSteps.length}`;
            box.className = `fixed bg-white p-4 rounded shadow-2xl border-l-4 border-amber-600 max-w-sm w-full z-[70] transition-all duration-500 ease-in-out ${step.positionClasses}`;

            const element = document.getElementById(step.elementId);
            if (element) {
                element.classList.add('tutorial-active-element');
                if(step.elementId === 'map-wrapper') setTimeout(() => map.invalidateSize(), 100);
            }
        }

        function nextTutorialStep() {
            tutorialStep++;
            if (tutorialStep >= tutorialSteps.length) endTutorial();
            else updateTutorialStep();
        }

        function endTutorial() {
            const box = document.getElementById('tutorial-box');
            box.classList.add('opacity-0');
            document.getElementById('tutorial-overlay').classList.remove('active');
            setTimeout(() => {
                box.classList.add('hidden');
                document.querySelectorAll('.tutorial-active-element').forEach(el => el.classList.remove('tutorial-active-element'));
            }, 500);
        }

        // --- MAP & EDIT LOGIK ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-btn');
            const hint = document.getElementById('edit-hint');
            
            if (isEditMode) {
                btn.classList.add('bg-amber-100', 'text-amber-800', 'border-amber-500');
                btn.classList.remove('bg-white', 'text-stone-500', 'border-stone-300');
                hint.classList.remove('hidden');
                document.getElementById('map').classList.add('cursor-crosshair');
                
                // Stationen draggable
                markers.forEach(m => {
                    m.dragging.enable();
                    m._icon.classList.add('cursor-move');
                });
                renderWaypointMarkers();
            } else {
                btn.classList.remove('bg-amber-100', 'text-amber-800', 'border-amber-500');
                btn.classList.add('bg-white', 'text-stone-500', 'border-stone-300');
                hint.classList.add('hidden');
                document.getElementById('map').classList.remove('cursor-crosshair');

                markers.forEach(m => {
                    m.dragging.disable();
                    m._icon.classList.remove('cursor-move');
                });
                clearWaypointMarkers();
            }
        }

        function renderWaypointMarkers() {
            clearWaypointMarkers();
            stations.forEach((station, sIdx) => {
                if(station.waypoints) {
                    station.waypoints.forEach((wp, wIdx) => {
                        const icon = L.divIcon({ className: 'waypoint-marker', iconSize: [12, 12], iconAnchor: [6, 6] });
                        const marker = L.marker(wp, { icon: icon, draggable: true }).addTo(map);
                        
                        marker.on('drag', (e) => {
                            const newPos = e.target.getLatLng();
                            station.waypoints[wIdx] = [newPos.lat, newPos.lng];
                            updatePolyline();
                        });
                        
                        // Right click to remove waypoint? Maybe too complex for now.
                        waypointMarkers.push(marker);
                    });
                }
            });
        }

        function clearWaypointMarkers() {
            waypointMarkers.forEach(m => map.removeLayer(m));
            waypointMarkers = [];
        }

        function updatePolyline() {
            // Flatten all coordinates: Station -> Waypoints -> Next Station
            const fullPath = [];
            stations.forEach((s) => {
                fullPath.push(s.coords);
                if (s.waypoints) {
                    s.waypoints.forEach(wp => fullPath.push(wp));
                }
            });
            polyline.setLatLngs(fullPath);
        }

        // Neue Funktion: Waypoint hinzufügen bei Klick auf Polyline
        function addWaypointAtClick(latlng) {
            if(!isEditMode) return;
            
            // Einfacher Algorithmus: Finde das nächste Segment
            // Wir iterieren durch Stationen und deren Waypoints und finden den Punkt, 
            // der dem Klick am nächsten ist, um einzufügen.
            // Vereinfachung: Wir fügen es einfach der Station hinzu, die am nächsten "davor" liegt.
            
            let bestStationIdx = -1;
            let bestInsertIdx = -1; // 0 = start, 1+ = after waypoint index
            let minDistance = Infinity;

            // Wir prüfen Distanzen zu den Liniensegmenten
            // Das ist komplex in reinem JS. 
            // Workaround für Vibe Coding: Wir fügen den Punkt einfach am Ende der Waypoints 
            // der Station hinzu, die dem Klick am nächsten ist (aber davor in der Reihenfolge).
            
            // Bessere Vibe-Lösung: Finde die Station, deren Index < currentIndex (oder wir nutzen globale Distanz).
            // Wir nehmen an, der Nutzer klickt zwischen Station A und B.
            
            let closestStation = stations[0];
            let closestDist = map.distance(latlng, stations[0].coords);
            let closestIdx = 0;

            stations.forEach((s, idx) => {
                if (idx === stations.length - 1) return; // Letzte Station hat keine nachfolgende Verbindung
                const d = map.distance(latlng, s.coords);
                // Grobe Heuristik: Wir fügen es der Station hinzu, die räumlich am nächsten ist 
                // UND in der Liste nicht die allerletzte ist.
                // Um es präzise zu machen, müssten wir lotrechte Abstände messen. 
                // Für dieses Tool reicht: Füge es der Station hinzu, deren Polyline-Segment geklickt wurde.
                // Leaflet click event gibt uns das nicht direkt.
                
                // Wir nutzen einfach die aktuelle Station (currentIndex) wenn sie Sinn macht, 
                // sonst die geographisch nächste.
                
                // Wir nehmen einfach an, der User klickt grob in die Nähe der Linie von Station X.
                // Wir fügen den Punkt einfach der Station hinzu, die am nächsten ist.
                if (d < closestDist) {
                    closestDist = d;
                    closestStation = s;
                    closestIdx = idx;
                }
            });

            // Wir fügen den neuen Punkt zu den Waypoints der gefundenen Station hinzu
            if (!stations[closestIdx].waypoints) stations[closestIdx].waypoints = [];
            stations[closestIdx].waypoints.push([latlng.lat, latlng.lng]);
            
            // Refresh
            updatePolyline();
            renderWaypointMarkers();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([20, -10], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            stations.forEach((station, index) => {
                const marker = L.marker(station.coords, { draggable: false }).addTo(map);
                const popupContent = `
                    <div style="font-family: 'Merriweather', serif; padding: 4px;">
                        <strong style="font-size: 1.1em; display:block; margin-bottom:4px;">${station.location}</strong>
                        <span style="font-family: 'Inter', sans-serif; color: #666;">${station.title}</span>
                    </div>
                `;
                marker.bindPopup(popupContent);
                
                marker.on('click', () => { if (!isEditMode) { currentIndex = index; updateUI(); } });
                marker.on('drag', function(event) {
                    const position = event.target.getLatLng();
                    stations[index].coords = [position.lat, position.lng];
                    updatePolyline();
                });

                markers.push(marker);
            });

            // Init Polyline
            polyline = L.polyline([], {
                color: '#78350f', weight: 3, opacity: 0.6, dashArray: '10, 10', className: 'clickable-polyline'
            }).addTo(map);
            
            // Click Event für Polyline (Neue Punkte)
            polyline.on('click', function(e) {
                if(isEditMode) {
                    addWaypointAtClick(e.latlng);
                }
            });

            updatePolyline(); // Initial draw with waypoints

            L.control.zoom({ position: 'bottomright' }).addTo(map);
            updateMapState();
        }

        // --- TIMELINE & UI (Same as before) ---
        function initTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = ''; 
            stations.forEach((station, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center gap-1.5 cursor-pointer group relative';
                wrapper.onclick = () => { currentIndex = index; updateUI(); };
                const node = document.createElement('div');
                node.id = `timeline-node-${index}`;
                node.className = `w-3 h-3 rounded-full border-2 transition-all duration-300 z-10 ${index === 0 ? 'bg-amber-700 border-amber-500 scale-125 timeline-node-active' : 'bg-stone-800 border-stone-500 hover:bg-stone-600'}`;
                const label = document.createElement('span');
                label.id = `timeline-label-${index}`;
                label.className = `text-[10px] font-serif font-bold transition-colors duration-300 ${index === 0 ? 'text-amber-500' : 'text-stone-500 group-hover:text-stone-300'}`;
                label.innerText = station.year;
                const tooltip = document.createElement('div');
                tooltip.className = 'absolute bottom-8 bg-stone-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none';
                tooltip.innerText = station.location;
                wrapper.appendChild(tooltip); wrapper.appendChild(node); wrapper.appendChild(label); container.appendChild(wrapper);
            });
        }
        function updateTimelineState() {
            stations.forEach((_, index) => {
                const node = document.getElementById(`timeline-node-${index}`);
                const label = document.getElementById(`timeline-label-${index}`);
                if (index === currentIndex) {
                    node.className = 'w-3 h-3 rounded-full border-2 transition-all duration-300 z-10 bg-amber-700 border-amber-500 scale-125 timeline-node-active';
                    label.className = 'text-[10px] font-serif font-bold transition-colors duration-300 text-amber-500';
                } else if (index < currentIndex) {
                    node.className = 'w-3 h-3 rounded-full border-2 transition-all duration-300 z-10 bg-amber-900/50 border-amber-800 cursor-pointer hover:bg-amber-700';
                    label.className = 'text-[10px] font-serif font-bold transition-colors duration-300 text-stone-400';
                } else {
                    node.className = 'w-3 h-3 rounded-full border-2 transition-all duration-300 z-10 bg-stone-800 border-stone-600 cursor-pointer hover:bg-stone-600';
                    label.className = 'text-[10px] font-serif font-bold transition-colors duration-300 text-stone-600';
                }
            });
        }
        function updateUI() {
            const station = stations[currentIndex];
            const hasPrev = currentIndex > 0;
            const hasNext = currentIndex < stations.length - 1;
            const elements = ['station-year', 'station-location', 'station-description', 'station-context'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                el.style.opacity = '0';
                el.style.transform = 'translateY(5px)';
            });
            setTimeout(() => {
                document.getElementById('station-count').innerText = currentIndex + 1;
                document.getElementById('station-year').innerText = station.year;
                document.getElementById('station-location').innerText = station.location;
                document.getElementById('station-description').innerText = station.description;
                document.getElementById('station-context').innerText = station.context;
                const prevBtn = document.getElementById('btn-prev');
                prevBtn.disabled = !hasPrev;
                if (!hasPrev) { prevBtn.classList.add('opacity-30', 'cursor-not-allowed'); prevBtn.classList.remove('hover:bg-stone-200'); } else { prevBtn.classList.remove('opacity-30', 'cursor-not-allowed'); prevBtn.classList.add('hover:bg-stone-200'); }
                const nextBtn = document.getElementById('btn-next');
                const nextBtnText = document.getElementById('btn-next-text');
                nextBtn.disabled = !hasNext;
                nextBtnText.innerText = hasNext ? 'Weiter' : 'Ende';
                if (!hasNext) { nextBtn.classList.add('opacity-50', 'cursor-not-allowed'); nextBtn.classList.remove('hover:bg-stone-700', 'hover:shadow-lg'); } else { nextBtn.classList.remove('opacity-50', 'cursor-not-allowed'); nextBtn.classList.add('hover:bg-stone-700', 'hover:shadow-lg'); }
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    el.style.transition = 'all 0.5s ease-out';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                });
            }, 300);
            updateMapState();
            updateTimelineState();
        }
        function updateMapState() {
            const station = stations[currentIndex];
            const zoomLevel = (station.id === 2) ? 4 : (station.id === 1 ? 6 : 8); 
            map.flyTo(station.coords, zoomLevel, { duration: 1.5, easeLinearity: 0.25 });
            markers.forEach((marker, idx) => {
                if (idx === currentIndex) { marker.setOpacity(1); marker.setZIndexOffset(1000); setTimeout(() => marker.openPopup(), 500); } 
                else { marker.setOpacity(0.6); marker.setZIndexOffset(0); marker.closePopup(); }
            });
        }
        function nextStation() { if (currentIndex < stations.length - 1) { currentIndex++; updateUI(); } }
        function prevStation() { if (currentIndex > 0) { currentIndex--; updateUI(); } }
        function toggleIntro() { const m = document.getElementById('intro-modal'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);} else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300);} }
        function toggleContext() { const m = document.getElementById('context-modal'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);} else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300);} }

        window.addEventListener('load', () => { initTimeline(); initMap(); setTimeout(() => map.invalidateSize(), 100); });
    </script>
</body>
</html>
